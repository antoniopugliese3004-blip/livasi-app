<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Livasì Manager - Sistema Listini</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerie PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const realFirebaseConfig = {
            apiKey: "AIzaSyBFi7X_eZqtVHJSgVqHba2bOppHpBxXbRg",
            authDomain: "salumificio-livasi.firebaseapp.com",
            projectId: "salumificio-livasi",
            storageBucket: "salumificio-livasi.firebasestorage.app",
            messagingSenderId: "87412524593",
            appId: "1:87412524593:web:2d3546fe34a3fda03bb710",
            measurementId: "G-ZW785REKNE"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : realFirebaseConfig;
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'salumificio-livasi';

        window.fb = { 
            db, auth, doc, setDoc, collection, onSnapshot, deleteDoc, 
            signInAnonymously, signInWithCustomToken, onAuthStateChanged, appId,
            initialToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const DEFAULT_PRODUCTS = [
            { id: '0000', code: '0000', producer: 'Salumificio Livasì', name: "‘Nduja di Spilinga Formato Orba", cost: 3.20, vat: 10, shelfLife: "365 gg", unit: "Kg", weight: "da 1,5kg a 3kg", basePrice: 8.50 },
            { id: '0001', code: '0001', producer: 'Salumificio Livasì', name: "‘Nduja di Spilinga Formato Crespone", cost: 3.50, vat: 10, shelfLife: "365 gg", unit: "Kg", weight: "da 0,3kg a 0,45kg", basePrice: 8.50 },
            { id: '0001C', code: '0001C', producer: 'Salumificio Livasì', name: "‘Nduja di Spilinga Formato Collato", cost: 3.00, vat: 10, shelfLife: "365 gg", unit: "Kg", weight: "da 5kg a 6kg", basePrice: 8.00 },
            { id: '0001P', code: '0001P', producer: 'Salumificio Livasì', name: "Nduja in secchiello 800g", cost: 3.10, vat: 10, shelfLife: "1095 gg", unit: "Kg", weight: "0,800 kg", basePrice: 9.50 },
            { id: '0014', code: '0014', producer: 'Salumificio Livasì', name: "‘Nduja di Spilinga Formato Orba Nero di Calabria", cost: 4.20, vat: 10, shelfLife: "365 gg", unit: "Kg", weight: "da 0,5kg a 2kg", basePrice: 12.00 },
            { id: '0002', code: '0002', producer: 'Salumificio Livasì', name: "Soppressata Dolce", cost: 11.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,25kg a 0,4kg", basePrice: 16.00 },
            { id: '0003', code: '0003', producer: 'Salumificio Livasì', name: "Soppressata Piccante", cost: 11.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,25kg a 0,4kg", basePrice: 16.00 },
            { id: '0004', code: '0004', producer: 'Salumificio Livasì', name: "Culatello", cost: 15.00, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,5kg a 1,5kg", basePrice: 26.00 },
            { id: '0005', code: '0005', producer: 'Salumificio Livasì', name: "Capocollo", cost: 13.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,5kg a 1,5kg", basePrice: 22.00 },
            { id: '0006', code: '0006', producer: 'Salumificio Livasì', name: "Salsiccia dolce", cost: 10.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,25kg a 0,4kg", basePrice: 15.00 },
            { id: '0007', code: '0007', producer: 'Salumificio Livasì', name: "Salsiccia Piccante", cost: 10.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,25kg a 0,4kg", basePrice: 15.00 },
            { id: '0008', code: '0008', producer: 'Salumificio Livasì', name: "Guanciale", cost: 5.00, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,4kg a 1,5kg", basePrice: 11.00 },
            { id: '0009', code: '0009', producer: 'Salumificio Livasì', name: "Pancetta Arrotolata", cost: 6.00, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,5kg a 3kg", basePrice: 12.50 },
            { id: '0010', code: '0010', producer: 'Salumificio Livasì', name: "Pancetta Tesa", cost: 5.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,5kg a 3kg", basePrice: 12.00 },
            { id: '0011', code: '0011', producer: 'Salumificio Livasì', name: "Vasetto ‘Nduja di Spilinga 212ml", cost: 1.20, vat: 10, shelfLife: "730 gg", unit: "Kg", weight: "180g", basePrice: 2.70 },
            { id: '0016', code: '0016', producer: 'Salumificio Livasì', name: "Vasetto ‘Nduja di Spilinga 106ml", cost: 0.50, vat: 10, shelfLife: "730 gg", unit: "Kg", weight: "90g", basePrice: 1.70 },
            { id: '0017', code: '0017', producer: 'Salumificio Livasì', name: "Salsiccia alla Cipolla Rossa di Tropea", cost: 11.50, vat: 10, shelfLife: "180 gg", unit: "Kg", weight: "da 0,25kg a 0,4kg", basePrice: 16.00 }
        ];

        const LOGO_KEYS = [
            { key: 'frontespizio', label: 'Immagine Frontespizio' },
            { key: 'logoAziendale', label: 'Logo Livasì (Intestazione)' },
            { key: 'cert1', label: 'Logo BRCGS' },
            { key: 'cert2', label: 'Logo IFS Food' },
            { key: 'cert3', label: 'Logo Consorzio \'Nduja' },
            { key: 'cert4', label: 'Logo Coldiretti' },
            { key: 'cert5', label: 'Logo Campagna Amica' }
        ];

        const PAYMENT_METHODS = [
            "Bonifico anticipato (la merce verrà spedita solo dopo la verifica di incasso pagamento)",
            "Contrassegno (al costo di 5€ + iva)",
            "Bonifico 15gg data fattura",
            "Bonifico 30gg fine mese",
            "Bonifico 60gg fine mese",
            "Da concordare"
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('listino');
            const [products, setProducts] = useState([]);
            const [selectedProducts, setSelectedProducts] = useState([]);
            const [clientName, setClientName] = useState('');
            const [paymentMethod, setPaymentMethod] = useState(PAYMENT_METHODS[0]);
            const [listType, setListType] = useState('standard');
            const [assets, setAssets] = useState({});
            const [isUploading, setIsUploading] = useState(null);
            const [isAddingProduct, setIsAddingProduct] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [editingProduct, setEditingProduct] = useState(null);
            const [editingListIndex, setEditingListIndex] = useState(null);
            const [isAnagraficaEdit, setIsAnagraficaEdit] = useState(false);
            
            const initializedRef = useRef(false);

            useEffect(() => {
                const timer = setInterval(() => {
                    if (window.fb) {
                        clearInterval(timer);
                        const { auth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, collection, db, onSnapshot, setDoc, doc, appId, initialToken } = window.fb;
                        
                        const initAuth = async () => {
                            if (initialToken) await signInWithCustomToken(auth, initialToken);
                            else await signInAnonymously(auth);
                        };
                        initAuth().catch(err => console.error(err));

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                const assetsCol = collection(db, "artifacts", appId, "public", "data", "assets");
                                const productsCol = collection(db, "artifacts", appId, "public", "data", "products");

                                onSnapshot(assetsCol, (snap) => {
                                    const a = {}; snap.forEach(d => a[d.id] = d.data().base64);
                                    setAssets(a);
                                });

                                onSnapshot(productsCol, (snap) => {
                                    const p = []; snap.forEach(d => p.push({id: d.id, ...d.data()}));
                                    if (p.length === 0) {
                                        DEFAULT_PRODUCTS.forEach(item => setDoc(doc(productsCol, item.id), item));
                                    } else {
                                        setProducts(p);
                                        // Popolamento Automatico del listino con i 17 prodotti selettivi
                                        if (!initializedRef.current && p.length >= 1) {
                                            const stdIds = DEFAULT_PRODUCTS.map(i => i.id);
                                            const found = p.filter(i => stdIds.includes(i.id));
                                            if (found.length > 0) {
                                                const mapped = found.map(i => ({
                                                    ...i, 
                                                    finalPrice: i.basePrice, 
                                                    discount: 0,
                                                    markup: i.cost > 0 ? ((i.basePrice - i.cost) / i.cost * 100).toFixed(2) : 0
                                                }));
                                                setSelectedProducts(mapped);
                                                initializedRef.current = true;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    }
                }, 100);
                return () => clearInterval(timer);
            }, []);

            const handleFileUpload = (e, key) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                setIsUploading(key);
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const MAX = 1200;
                        if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } }
                        else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0,0,w,h);
                        ctx.drawImage(img, 0, 0, w, h);
                        const b64 = canvas.toDataURL('image/jpeg', 0.8);
                        const { db, setDoc, doc, appId } = window.fb;
                        await setDoc(doc(db, "artifacts", appId, "public", "data", "assets", key), { base64: b64 });
                        setIsUploading(null);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const generatePDF = () => {
                if (!window.jspdf) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const dateStr = new Date().toLocaleDateString('it-IT').replace(/\//g, '-');
                
                const renderHeader = (d) => {
                    if (assets.logoAziendale) { try { d.addImage(assets.logoAziendale, 'JPEG', 20, 10, 35, 15); } catch(e){} }
                    d.setFontSize(10); d.setTextColor(180, 0, 0); d.setFont(undefined, 'bold');
                    d.text("Salumificio Livasì", 115, 17, { align: 'center' });
                    d.setFontSize(8); d.setTextColor(100, 100, 100); d.setFont(undefined, 'normal');
                    d.text("Loc. Livasì snc, 89864 Spilinga VV", 115, 22, { align: 'center' });
                    d.setDrawColor(220); d.line(20, 32, 190, 32);
                };

                const renderFooter = (d) => {
                    const ph = d.internal.pageSize.height;
                    d.setDrawColor(220); d.line(20, ph - 35, 190, ph - 35);
                    let x = 35;
                    for (let i = 1; i <= 5; i++) {
                        const l = assets[`cert${i}`];
                        if (l) { try { d.addImage(l, 'JPEG', x, ph - 30, 25, 15); } catch(e){} }
                        x += 30;
                    }
                };

                // P1: FRONTESPIZIO
                if (assets.frontespizio) { try { doc.addImage(assets.frontespizio, 'JPEG', 0, 0, 210, 297); } catch(e){} }
                else { doc.setFillColor(20, 25, 40); doc.rect(0,0,210,297,'F'); }
                doc.setFillColor(0); doc.setGState(new doc.GState({opacity: 0.5}));
                doc.rect(0, 70, 210, 50, 'F'); doc.setGState(new doc.GState({opacity: 1}));
                doc.setTextColor(255); doc.setFontSize(32); doc.setFont(undefined, 'bold');
                doc.text("Salumificio Livasì", 105, 90, {align:'center'});
                doc.setFontSize(22); doc.text("LISTINO PREZZI", 105, 105, {align:'center'});
                if (clientName) {
                    doc.setGState(new doc.GState({opacity: 0.6})); doc.rect(0, 230, 210, 30, 'F'); doc.setGState(new doc.GState({opacity: 1}));
                    doc.setFontSize(14); doc.text(`Riservato a: ${clientName}`, 105, 245, {align:'center'});
                    doc.setFontSize(10); doc.text(`Data Emissione: ${dateStr}`, 105, 253, {align:'center'});
                }

                // P2: CONDIZIONI INTEGRALI
                doc.addPage(); renderHeader(doc);
                doc.setFillColor(255); doc.setGState(new doc.GState({opacity: 0.85})); doc.rect(15, 40, 180, 220, 'F'); doc.setGState(new doc.GState({opacity: 1}));
                doc.setTextColor(40); doc.setFontSize(8); let y = 48;
                const conditions = [
                    { t: "Nel ringraziarVi dell’interesse verso i nostri prodotti, sottoponiamo alla Vostra cortese attenzione la nostra offerta.", b: false },
                    { t: "1. IL NOSTRO SERVIZIO", b: true },
                    { t: "Il salumificio Livasì si impegna a fornire i suoi prodotti nel rispetto nei tempi e nelle modalità indicate nel presente documento. Tutti i nostri salumi subiscono una fase di affumicatura con legno di ulivo e quercia. Per tutti i prodotti vengono rispettati i tempi di stagionatura stabiliti dal know-how aziendale.", b: false },
                    { t: "2. Modalità di invio ordine", b: true },
                    { t: "Gli ordini potranno pervenire via email ai seguenti indirizzi:\n- amministrazione@livasi.com\n- commerciale@livasi.com\no via whatsapp al numero:\n- +39 0963582222\nI nostri operatori risponderanno nel più breve tempo possibile.", b: false },
                    { t: "3. Tempi di evasione ordine", b: true },
                    { t: "I tempi di evasione dell’ordine possono variare in base ai seguenti fattori:\n- Disponibilità del prodotto\n- Periodo di ricezione dell’ordine: generalmente nel periodo estivo e natalizio i tempi di evasione possono allungarsi di qualche giorno\nIn condizioni normali dalla ricezione dell’ordine questo viene preparato in 1/2gg lavorativi. La spedizione avviene con corriere espresso e gli ordini verranno evasi dal lunedì al mercoledì con tempi di consegna standard di 2gg lavorativi nel territorio italiano. Gli ordini pervenuti dal giovedì al sabato non verranno evasi prima del primo lunedì successivo. Sarà cura della nostra azienda avvisarvi per eventuali ritardi. Per ordini di vasetti e secchielli nell’ordine di minimo di un bancale i tempi di consegna verranno comunicati al momento dell’ordine", b: false },
                    { t: "4. Costi di spedizioni", b: true },
                    { t: "Per gli ordini superiore ai 30kg di merce la spedizione è gratuita solo per consegna in Italia. Per gli ordini inferiori ai 30 kg il costo di spedizione viene inserito in fattura e calcolato di volta in volta in base al peso e numero di colli inviati.\nPer le spedizioni fuori Italia il costo di spedizione è a carico del destinatario per qualsiasi ordine", b: false },
                    { t: "5. Modalità di pagamento", b: true },
                    { t: `Le modalità di pagamento sono le seguenti:\n- ${paymentMethod}`, b: false },
                    { t: "6. Obblighi alla ricezione della merce", b: true },
                    { t: "Al momento della ricezione della merce è necessario accettare la consegna con riserva di controllo. Dovrai spuntare la casella apposita su un foglio che terrà il corriere stesso. Se non è presente nessuna casella per la riserva, basterà scrivere \"Si accetta consegna con riserva di controllo\" ed apporre una firma. Se vedi danni al pacco, descrivi il danno sempre sul foglio che terrà il corriere, ad es.: \"si segnala un foro sul lato superiore del pacco\", e scatta subito una foto. Se il corriere si rifiuta di farvi firmare con riserva, può contattarci al numero 0963582222 o rifiutare la merce. Non si accetteranno reclami per merce mancante o danneggiata se non si esegue questa procedura", b: false }
                ];
                conditions.forEach(s => {
                    doc.setFont(undefined, s.b ? 'bold' : 'normal');
                    const lines = doc.splitTextToSize(s.t, 170);
                    doc.text(lines, 20, y); y += (lines.length * 4.2) + 2;
                });
                renderFooter(doc);

                // P3: LISTINO
                doc.addPage(); renderHeader(doc);
                doc.setFillColor(255); doc.setGState(new doc.GState({opacity: 0.85})); doc.rect(15, 38, 180, 222, 'F'); doc.setGState(new doc.GState({opacity: 1}));
                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text("LISTINO PREZZI DETTAGLIATO", 105, 45, {align:'center'});
                const tableData = selectedProducts.map(p => listType === 'standard' ? [p.code, p.name, p.weight, p.shelfLife, p.unit, p.vat+"%", p.finalPrice.toFixed(2)+"€"] : [p.code, p.name, p.weight, p.shelfLife, p.unit, p.vat+"%", p.basePrice.toFixed(2)+"€", p.discount+"%", p.finalPrice.toFixed(2)+"€"]);
                const tableHead = listType === 'standard' ? ["Codice", "Prodotto", "Peso", "Shelf Life", "U.M.", "IVA", "Prezzo"] : ["Codice", "Prodotto", "Peso", "Shelf Life", "U.M.", "IVA", "Listino", "Sconto", "Finale"];
                doc.autoTable({
                    startY: 55, head: [tableHead], body: tableData, theme: 'striped',
                    headStyles: { fillColor: [180, 0, 0], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [248, 248, 248] },
                    styles: { fontSize: 7, cellPadding: 2.5 },
                    margin: { left: 20, right: 20 },
                    didDrawPage: (d) => {
                        doc.setFontSize(7.5); doc.setTextColor(100); doc.setFont(undefined, 'italic');
                        const disclaimer = "Il prezzo è da considerarsi escluso IVA. l’IVA indicata è valida per la fatturazione in Italia. Per la fatturazione estera verrà utilizzato il codice IVA relativa alla normativa di riferimento.";
                        doc.text(doc.splitTextToSize(disclaimer, 160), 25, d.cursor.y + 10);
                    }
                });
                renderFooter(doc);
                doc.save(`Listino_${clientName || 'Cliente'}_${dateStr}.pdf`);
            };

            const saveProduct = async (p) => {
                const { db, setDoc, doc, appId } = window.fb;
                const pId = p.id || crypto.randomUUID();
                await setDoc(doc(db, "artifacts", appId, "public", "data", "products", pId), { ...p, id: pId });
                setIsAnagraficaEdit(false); setEditingProduct(null);
            };

            const filteredAnagrafica = useMemo(() => {
                return products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || p.code.toLowerCase().includes(searchQuery.toLowerCase()));
            }, [products, searchQuery]);

            return (
                <div className="min-h-screen pb-24 selection:bg-red-100">
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-red-700 rounded-xl flex items-center justify-center text-white font-black shadow-lg">L</div>
                            <h1 className="font-black text-slate-800 tracking-tighter text-lg leading-none uppercase">Livasì Manager</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setActiveTab('listino')} className={`p-3 rounded-xl transition-all ${activeTab === 'listino' ? 'bg-red-50 text-red-700 shadow-inner' : 'text-slate-400'}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                            </button>
                            <button onClick={() => setActiveTab('anagrafica')} className={`p-3 rounded-xl transition-all ${activeTab === 'anagrafica' ? 'bg-red-50 text-red-700 shadow-inner' : 'text-slate-400'}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            </button>
                        </div>
                    </header>

                    <main className="p-4 max-w-2xl mx-auto space-y-6">
                        {activeTab === 'listino' ? (
                            <div className="space-y-6 animate-fade-in">
                                <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 space-y-5">
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cliente</label><input type="text" className="w-full p-2 border-b font-bold text-lg outline-none focus:border-red-500 bg-transparent" value={clientName} onChange={e => setClientName(e.target.value)} placeholder="Inserisci nome cliente..." /></div>
                                    <div className="flex gap-2 p-1 bg-slate-100 rounded-2xl"><button onClick={() => setListType('standard')} className={`flex-1 py-2 text-[10px] font-black rounded-xl transition-all ${listType === 'standard' ? 'bg-white shadow-sm text-red-700' : 'text-slate-400'}`}>STANDARD</button><button onClick={() => setListType('discount')} className={`flex-1 py-2 text-[10px] font-black rounded-xl transition-all ${listType === 'discount' ? 'bg-white shadow-sm text-red-700' : 'text-slate-400'}`}>SCONTO</button></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Metodo Pagamento</label><select className="w-full p-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none" value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)}>{PAYMENT_METHODS.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                                </section>

                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-2"><h2 className="text-xs font-black text-slate-400 uppercase tracking-widest">Articoli Listino ({selectedProducts.length})</h2><button onClick={() => { setIsAnagraficaEdit(false); setIsAddingProduct(true); }} className="p-2 bg-slate-900 text-white rounded-xl shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div>
                                    {selectedProducts.map((p, i) => (
                                        <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center animate-fade-in">
                                            <div className="flex-1 min-w-0"><p className="text-[10px] font-bold text-red-600 uppercase tracking-tighter">{p.code}</p><h3 className="font-bold truncate text-sm text-slate-800">{p.name}</h3><p className="text-[11px] text-slate-400 italic">{p.weight} • <span className="font-bold text-slate-900">{p.finalPrice.toFixed(2)}€</span></p></div>
                                            <div className="flex gap-1 ml-4"><button onClick={() => { setEditingProduct({...p}); setEditingListIndex(i); setIsAddingProduct(true); setIsAnagraficaEdit(false); }} className="p-2 text-slate-300 hover:text-blue-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button onClick={() => setSelectedProducts(selectedProducts.filter((_, idx) => idx !== i))} className="p-2 text-slate-300 hover:text-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={generatePDF} className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-3xl font-black shadow-2xl active:scale-95 transition-all text-sm uppercase tracking-widest flex items-center gap-3 z-50"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> GENERA PDF</button>
                            </div>
                        ) : (
                            <div className="space-y-8 animate-fade-in">
                                <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                    <h2 className="font-black text-xs uppercase tracking-widest mb-6 flex items-center gap-2 text-slate-400">Asset Grafici PDF</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {LOGO_KEYS.map(({ key, label }) => (
                                            <div key={key} className="p-4 bg-slate-50 border border-slate-100 rounded-3xl flex flex-col gap-3">
                                                <div className="flex justify-between items-center"><span className="text-[10px] font-bold text-slate-400 uppercase">{label}</span>{isUploading === key ? <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-red-700"></div> : assets[key] ? <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg> : null}</div>
                                                <label className="cursor-pointer bg-white border border-slate-200 text-center py-2 rounded-xl text-[10px] font-black hover:bg-slate-100 uppercase transition-all">{assets[key] ? 'Sostituisci' : 'Carica'}<input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(e, key)} /></label>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section className="space-y-4 pb-20">
                                    <div className="flex justify-between items-center px-2"><h2 className="text-xs font-black text-slate-400 uppercase tracking-widest">Anagrafica Prodotti</h2><button onClick={() => { setEditingProduct({code:'', name:'', cost:0, vat:10, producer:'Salumificio Livasì', unit:'Kg', weight:'', shelfLife:'180 gg', basePrice:0}); setIsAnagraficaEdit(true); }} className="p-2 bg-slate-900 text-white rounded-xl shadow-lg active:scale-95 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div>
                                    <div className="relative mb-4"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" className="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl outline-none font-bold" placeholder="Filtra prodotti..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} /></div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || p.code.toLowerCase().includes(searchQuery.toLowerCase())).map(p => (
                                            <div key={p.id} className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex flex-col gap-3 group animate-fade-in">
                                                <div className="flex justify-between items-start"><span className="text-[10px] font-black bg-slate-100 text-slate-500 px-3 py-1 rounded-full uppercase tracking-widest">{p.code}</span><div className="flex gap-2"><button onClick={() => { setEditingProduct({...p}); setIsAnagraficaEdit(true); }} className="text-blue-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button onClick={async () => { if(confirm('Eliminare articolo?')) { const {db, deleteDoc, doc, appId} = window.fb; await deleteDoc(doc(db, "artifacts", appId, "public", "data", "products", p.id)); } }} className="text-red-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div>
                                                <h3 className="font-black text-slate-800 leading-tight">{p.name}</h3>
                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{p.producer}</p>
                                                <div className="grid grid-cols-4 gap-2 pt-3 border-t border-slate-50 text-xs">
                                                    <div><p className="text-slate-400 uppercase font-bold text-[8px]">Prezzo</p><p className="font-black text-red-600">{p.basePrice.toFixed(2)}€</p></div>
                                                    <div className="border-x px-2"><p className="text-slate-400 uppercase font-bold text-[8px]">Costo</p><p className="font-bold">{p.cost.toFixed(2)}€</p></div>
                                                    <div className="px-2 border-r"><p className="text-slate-400 uppercase font-bold text-[8px]">IVA</p><p className="font-bold text-slate-700">{p.vat}%</p></div>
                                                    <div><p className="text-slate-400 uppercase font-bold text-[8px]">Shelf Life</p><p className="font-medium text-slate-500 text-[9px]">{p.shelfLife}</p></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}
                    </main>

                    {/* MODALE EDITOR ANAGRAFICA */}
                    {isAnagraficaEdit && editingProduct && (
                        <div className="fixed inset-0 z-[110] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-8 border-b border-slate-50 flex justify-between items-center"><h3 className="font-black text-slate-800 text-xl uppercase tracking-tighter">Editor Prodotto</h3><button onClick={() => { setIsAnagraficaEdit(false); setEditingProduct(null); }} className="p-2 border border-slate-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
                                <div className="p-8 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 custom-scroll">
                                    <div className="space-y-1 md:col-span-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">Nome Articolo</label><input type="text" value={editingProduct.name} onChange={e => setEditingProduct({...editingProduct, name: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-red-500 font-bold" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">Codice</label><input type="text" value={editingProduct.code} onChange={e => setEditingProduct({...editingProduct, code: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold text-slate-500" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">Produttore</label><input type="text" value={editingProduct.producer} onChange={e => setEditingProduct({...editingProduct, producer: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">Peso (es. 1.5kg-3kg)</label><input type="text" value={editingProduct.weight} onChange={e => setEditingProduct({...editingProduct, weight: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">Unità di Misura</label><input type="text" value={editingProduct.unit} onChange={e => setEditingProduct({...editingProduct, unit: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">IVA %</label><input type="number" value={editingProduct.vat} onChange={e => setEditingProduct({...editingProduct, vat: parseInt(e.target.value) || 0})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">Costo Produzione (€)</label><input type="number" step="0.01" value={editingProduct.cost} onChange={e => setEditingProduct({...editingProduct, cost: parseFloat(e.target.value) || 0})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold" /></div>
                                    <div className="space-y-1 md:col-span-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-1">Prezzo Base Vendita (€)</label><input type="number" step="0.01" value={editingProduct.basePrice} onChange={e => setEditingProduct({...editingProduct, basePrice: parseFloat(e.target.value) || 0})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold text-red-600" /></div>
                                </div>
                                <div className="p-8 border-t bg-slate-50/50 flex gap-4"><button onClick={() => { setIsAnagraficaEdit(false); setEditingProduct(null); }} className="flex-1 py-4 border border-slate-200 rounded-2xl font-black text-slate-500 uppercase text-sm">Annulla</button><button onClick={() => saveProduct(editingProduct)} className="flex-1 py-4 bg-red-700 text-white rounded-2xl font-black shadow-xl uppercase text-sm active:scale-95 transition-all">Salva in Archivio</button></div>
                            </div>
                        </div>
                    )}
                    
                    {/* MODALE LISTINO */}
                    {isAddingProduct && !isAnagraficaEdit && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/90 backdrop-blur-xl flex items-end md:items-center justify-center p-0 md:p-6 animate-fade-in">
                            <div className="bg-white w-full max-w-xl rounded-t-[3.5rem] md:rounded-[3.5rem] p-10 space-y-8 shadow-2xl overflow-y-auto max-h-[95vh] relative">
                                <button onClick={() => { setIsAddingProduct(false); setEditingProduct(null); }} className="absolute right-8 top-8 p-2 hover:bg-slate-100 rounded-full transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                                {editingProduct ? (
                                    <div className="space-y-8 animate-fade-in">
                                        <div className="bg-red-700 p-8 rounded-[3rem] text-white relative shadow-2xl overflow-hidden">
                                            <h4 className="font-black text-2xl leading-tight">{editingProduct.name}</h4>
                                            <p className="text-[10px] font-black text-red-200 mt-2 uppercase tracking-widest">{editingProduct.code} • {editingProduct.weight}</p>
                                        </div>
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Prezzo Listino (€)</label><input type="number" step="0.01" className="w-full p-5 bg-slate-50 border border-slate-100 rounded-3xl font-black text-2xl text-red-700 outline-none" value={editingProduct.basePrice} onChange={e => {
                                                const v = parseFloat(e.target.value) || 0;
                                                const m = editingProduct.cost > 0 ? ((v - editingProduct.cost) / editingProduct.cost * 100).toFixed(2) : 0;
                                                setEditingProduct({...editingProduct, basePrice: v, markup: m});
                                            }} /></div>
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Rincaro (%)</label><input type="number" className="w-full p-5 bg-slate-50 border border-slate-100 rounded-3xl font-black text-2xl outline-none" value={editingProduct.markup} onChange={e => {
                                                const val = parseFloat(e.target.value) || 0;
                                                const p = editingProduct.cost * (1 + val/100);
                                                setEditingProduct({...editingProduct, basePrice: p.toFixed(2), markup: val});
                                            }} /></div>
                                            {listType === 'discount' && (
                                                <div className="col-span-2 space-y-2 bg-blue-50/50 p-6 rounded-[2.5rem] border border-blue-100 animate-fade-in">
                                                    <label className="text-[10px] font-black text-blue-500 uppercase tracking-widest text-center block">Sconto Dedicato (%)</label>
                                                    <input type="number" className="w-full p-5 bg-white border border-blue-200 rounded-3xl font-black text-2xl text-blue-700 outline-none text-center" value={editingProduct.discount} onChange={e => setEditingProduct({...editingProduct, discount: parseFloat(e.target.value) || 0})} />
                                                </div>
                                            )}
                                        </div>
                                        <button onClick={() => {
                                            const final = listType === 'discount' ? editingProduct.basePrice * (1 - (editingProduct.discount || 0) / 100) : editingProduct.basePrice;
                                            const updated = { ...editingProduct, finalPrice: parseFloat(final) };
                                            if (editingListIndex !== null) { const newList = [...selectedProducts]; newList[editingListIndex] = updated; setSelectedProducts(newList); } 
                                            else { setSelectedProducts([...selectedProducts, updated]); }
                                            setIsAddingProduct(false); setEditingProduct(null); setEditingListIndex(null);
                                        }} className="w-full bg-slate-900 text-white py-6 rounded-3xl font-black uppercase tracking-widest shadow-2xl active:scale-95 transition-all">AGGIUNGI AL LISTINO</button>
                                    </div>
                                ) : (
                                    <div className="space-y-6 animate-fade-in">
                                        <h3 className="font-black uppercase tracking-widest text-sm text-slate-400">Ricerca Articolo da Anagrafica</h3>
                                        <input type="text" className="w-full p-4 bg-slate-100 border-none rounded-2xl outline-none font-bold shadow-inner" placeholder="Cerca..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                        <div className="space-y-2 max-h-[50vh] overflow-y-auto custom-scroll pr-2">
                                            {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || p.code.toLowerCase().includes(searchQuery.toLowerCase())).map(p => (
                                                <button key={p.id} onClick={() => setEditingProduct({...p, discount: 0, markup: p.cost > 0 ? ((p.basePrice - p.cost) / p.cost * 100).toFixed(2) : 0})} className="w-full flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl hover:border-red-500 transition-all text-left">
                                                    <div><p className="text-[9px] font-black text-slate-300 uppercase mb-1">{p.code}</p><h4 className="font-black text-slate-800">{p.name}</h4></div>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
